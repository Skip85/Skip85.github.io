<html>
  <head>
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex">


    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.11/lodash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
    <script src="https://unpkg.com/async-oauth-popup@1.0.3/dist/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qs/6.7.0/qs.min.js"></script>

    <link href="style.css" rel="stylesheet">

    <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@600;800;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clappr/0.4.0/clappr.min.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Swiper/5.4.5/css/swiper.min.css">
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
  </head>

  <body>
    <script type="text/x-template" id="vue-slide-template">
      <div :id="targetId" style="background: red;"></div>
    </script>

    <script>
      Vue.component('vue-slide', {
        template: '#vue-slide-template',

        props: {
          slide: { type: Object, required: true },
        },

        data() {
          return {
            targetId: `slide-${this.slide.id}`,
            isSliderIntersect: false,
            player: null,
            timeIsOver: false,
          };
        },

        watch: {
          slide: {
            deep: true,
            handler(value) {
              if (this.timeIsOver) return;

              if (value['$isIntersecting']) {
                this.player.play();
              }
              else {
                this.player.pause();
              }
            }
          }
        },

        mounted() {
          const vm = this;

          var playerElement = document.getElementById(this.targetId);

          vm.player = new Clappr.Player({
            source: this.slide.content.playlist_url,
            poster: this.slide.content.poster.image_url,
            mute: true,
            width: '100%',
            chromeless: true,
            events: {
              onReady() {
                if (vm.slide.start_offset) {
                  this.seek(vm.slide.start_offset);
                }
              },
              onTimeUpdate(statusObject) {
                if (statusObject.current >= vm.slide.end_offset) {
                  vm.player.stop();
                  vm.timeIsOver = true;
                }
              }
            }
          });

          vm.player.attachTo(playerElement);

          // this.$nextTick(() => {
          //   var options = {
          //     threshold: 0.5
          //   };

          //   var target = document.querySelector(`#${this.targetId}`);


          //   if (!target) return;

          //   var callback = function(entries, observer) {
          //     entries.forEach(entry => {
          //       vm.isSliderIntersect = entry.isIntersecting;
          //     });
          //   };

          //   var observer = new IntersectionObserver(callback, options);
          //   observer.observe(target);
          // });
        },
      })
    </script>

    <div id="app">
      <div class="header">
        <div class="container">
          <img class="icon" src="img/icon.svg" alt="">
          <h1 class="title">Как быстро <br> выбрать кино?</h1>
          <p class="description">Что посмотреть, когда ищешь новое или не можешь <br> вспомнить тот самый фильм</p>
        </div>
      </div>
  
      <div class="information">
        <div class="container">
          <h3>Хотите разгрузить голову, найти<br>
            правильный хоррор, чтобы прижаться<br>
            подближе друг к другу на свидании?
          </h3>
  
          <div class="information-actions">
            <span class="information-actions__item">Изучать историю</span>
            <span class="information-actions__item">Вдохновиться классикой</span>
            <span class="information-actions__item">Скоротать время</span>
          </div>
        </div>
      </div>

      <div class="moments-container">
        <div class="container">
          <h2>Выбирайте <br> через моменты</h2>
          <p class="moments-container__description">Колдовство, классика жанра, российские премьеры — мы собрали <br>
            все для того, чтобы вы быстрее нашли правильное кино
          </p>

          <div class="slider">
            <div v-if="false" class="choosen-moment">
              <div class="choosen-moment__actions">
                <div class="button button-outline">
                  Сцены с поцелуями
                </div>
                <div class="button button-outline">
                  Сцены с поцелуями
                </div>
                <div class="button button-outline">
                  Сцены с поцелуями
                </div>
                <div class="button button-outline">
                  Сцены с поцелуями
                </div>
                <div @click="isOpenedMenu = true" class="button button-red">
                  Показать все +
                </div>
              </div>
              <div class="choosen-moment__item--container">
                <div
                  v-for="choosen in choosenMoments"
                  :key="choosen.id"
                  class="choosen-moment__item"
                  >
                  <template>
                    <img src="img/slider-item.png" alt="">
                    <div class="slider-item-banner__contaier">
                      <div class="slider-item-banner">
                        <div class="item-banner__image-container">
                          <img src="img/banner.png" alt="" class="banner">
                        </div>
                        <div class="item-banner__info">
                          <h3 class="banner-title">
                            {{ [selectedMoment.name, selectedMoment.year].join(', ') }}
                          </h3>
                          <div class="banner-description">{{ selectedMoment.description }}</div>
                          <div class="banner-actions">
                            <div class="button button-outline-red">Перейти к просмотру</div>
                            <div class="button button-red">Вернуться к моментам</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </template>
                </div>
              </div>
            </div>

            <template v-else>
              <!-- <div
                v-for="(moment, idx) in moments"
                :key="idx"
                @click="selectedMoment = moment"
                class="item slider-item"
                > -->
                <div v-if="selectedMoment" class="swiper-container">
                  <div class="swiper-wrapper">
                    <div v-for="slide in selectedMoment.moments" :key="slide.id" class="swiper-slide slider-item">
                      <div class="swiper-slide-pseudo">
                        <div class="slider-item--more-content">
                          <img src="img/more-content.png" alt="">
                        </div>
    
                        <div class="slider-item--info">
                          <span class="moment-name">{{ slide.title }}</span>
                          <p class="content-name">{{ slide.content.title }}</p>
                        </div>
                      </div>
    
                      <vue-slide
                        :slide="slide"
                        />
                    </div>
                  </div>
                  <div class="swiper-scrollbar"></div>
                </div>
              </div>
            </template>  
            
          </div>

          <h2>Почему так проще <br> выбрать кино</h2>

          <div class="about">
            <div class="about-item">
              <img class="eyes" src="img/eyes.png" alt="">
              <p class="about-item__title">Опирайтесь на свои эмоции</p>
              <div class="about-item__description">
                Часто рейтинги и чужие мнения не дают представления о фильме, а наоборот искажают ожидания.
                Поэтому доверяйте только своему мнению, выбрайте кино по ярким моментам фильма, опираясь на эмоциями
              </div>
            </div>

            <div class="about-item">
              <img class="lightning" src="img/lightning.png" alt="">
              <p class="about-item__title">Опирайтесь на свои эмоции</p>
              <div class="about-item__description">
                Часто рейтинги и чужие мнения не дают представления о фильме, а наоборот искажают ожидания.
                Поэтому доверяйте только своему мнению, выбрайте кино по ярким моментам фильма, опираясь на эмоциями
              </div>
            </div>

            <div class="about-item">
              <img class="heart" src="img/heart.png" alt="">
              <p class="about-item__title">Опирайтесь на свои эмоции</p>
              <div class="about-item__description">
                Часто рейтинги и чужие мнения не дают представления о фильме, а наоборот искажают ожидания.
                Поэтому доверяйте только своему мнению, выбрайте кино по ярким моментам фильма, опираясь на эмоциями
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="bottom">
        <div class="container">
          <h2>Выбирайте кино <br> прямо сейчас</h2>
          <p class="bottom-description">Вспоминайте любимое и открывайте новое — <br> подберите кино для настроения</p>
          <div class="button-container">
            <div class="button button-outline-light">Попробовать</div>
          </div>
          <div class="socials">Поделиться: инстаграме, фейсбуке, вконтакте</div>
        </div>
      </div>

      <div v-if="isOpenedMenu" class="menu-container">
        <div class="menu-close">
          <div @click="isOpenedMenu = false" class="close-icon"></div>  
        </div>
        <div class="menu-list">
          <div
            v-for="item in menuList"
            :key="item.id"
            class="menu-item"
            >
            <div class="menu-item__moment">{{ item.name }}</div>
            <div class="menu-item__films">
              <div
                v-for="film in item.films"
                :key="film.id"
                class="films-item"
                >
                <h2>{{ film.name }}</h2>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // регистрирую специальный инстанс аксиоса
      Vue.mixin({
        computed: {
          $axios: () => axios.create({
            baseURL: 'https://api-staging.viasat.su/api',
          }),
        }
      });

      var $vue = new Vue({
        el: "#app",
        data() {
          return {
            moments: [{
              id: 1,
              name: 'Амели',
              year: '2001',
              description: 'Вы можете продолжить смотреть этот фильм на Vip Play'
            }],
            choosenMoments: [{
              id: 1,
              name: 'Какой-то выбранный момент',
            }],
            selectedMoment: null,

            isOpenedMenu: false,
            menuList: [
              {
                id: 1,
                name: 'Сцены с поцелуями',
                films: [
                  {
                    id: 1,
                    name: 'Амели',
                    year: '2001',
                    description: 'Вы можете продолжить смотреть этот фильм на Vip Play',
                  },
                  {
                    id: 2,
                    name: 'Колдуй с Гарри Поттером',
                    year: '2001',
                    description: 'Вы можете продолжить смотреть этот фильм на Vip Play',
                  },
                  {
                    id: 3,
                    name: 'Сцены с драками',
                    year: '2001',
                    description: 'Вы можете продолжить смотреть этот фильм на Vip Play',
                  },
                ],
              },
              {
                id: 2,
                name: 'Сцены с поцелуями',
                films: [
                  {
                    id: 1,
                    name: 'Амели',
                    year: '2001',
                    description: 'Вы можете продолжить смотреть этот фильм на Vip Play',
                  },
                ],
              },
              {
                id: 3,
                name: 'Сцены с поцелуями',
                films: [
                  {
                    id: 1,
                    name: 'Амели',
                    year: '2001',
                    description: 'Вы можете продолжить смотреть этот фильм на Vip Play',
                  },
                ],
              },
            ],
            isSliderIntersect: false,
            player: null,
            selectedMoment: null,
            collections: [],
          };
        },

        async mounted() {
          const vm = this;
          try {
            const { data: collections } = await this.$axios.get('/v1/moment_collections?include=moments');
            this.collections = collections;
            this.selectedMoment = this.collections[0];
          }
          catch (err) {
            console.error(err);
          }

          this.$nextTick(() => {
            const swiper = new Swiper('.swiper-container', {
              slidesPerView: 2,
              spaceBetween: 30,
              slidesOffsetAfter: 20,
              pagination: {
                el: '.swiper-pagination',
                clickable: true,
              },
            });

            const callback = function(entries, observer) {
              entries.forEach(entry => {
                const idx = _.findIndex(vm.selectedMoment.moments, { id: _.replace(entry.target.id, 'slide-', '') });
                vm.$set(vm.selectedMoment.moments[idx], '$isIntersecting', entry.isIntersecting);
              });
            };

            const observer = new IntersectionObserver(callback, options);
            for ( let i = 0; i < this.selectedMoment.moments.length; i++) {
              var options = {
                rootMargin: '0px',
                threshold: 1.0,
                id: vm.selectedMoment.moments[i].id,
              };
              observer.observe(document.querySelector(`#slide-${vm.selectedMoment.moments[i].id}`));
            }
          });
        }
      });
    </script>    
  </body>
</html>